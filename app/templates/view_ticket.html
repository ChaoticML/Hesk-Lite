{% extends 'layout.html' %}
{% block title %}Ticket #{{ ticket.id }}{% endblock %}
{% block content %}
    <div class="ticket-view-grid">
        <div class="ticket-main">
            <h1>#{{ ticket.id }}: {{ ticket.title }}</h1>

            <!-- Gekoppeld KB Artikel Weergave -->
            {% if ticket.kb_article_id %}
            <div class="linked-kb-article">
                <strong>Gekoppeld Kennisbank Artikel:</strong>
                <!-- Link naar KB artikel aangepast -->
                <a href="{{ url_for('kb.kb_article', article_id=ticket.kb_article_id) }}">{{ ticket.kb_article_title }}</a>
            </div>
            {% endif %}

            <div class="ticket-details">
                <div class="detail-section">
                    <p><strong>Status:</strong> {{ ticket.status }}</p>
                    <p><strong>Prioriteit:</strong> {{ ticket.priority }}</p>
                    <p><strong>Aangemaakt:</strong> {{ ticket.created_at | datetimeformat }}</p>
                </div>
                <div class="detail-section assignment-section">
                    <strong>Toegewezen aan:</strong>
                    {% if ticket.assigned_to %}
                        <span class="assigned-user">{{ ticket.assigned_to }}</span>
                    {% else %}
                        <span class="unassigned">Niet toegewezen</span>
                        <!-- Formulier voor 'Aan mij toewijzen' aangepast -->
                        <form action="{{ url_for('main.assign', ticket_id=ticket.id) }}" method="post" style="display: inline-block; margin-left: 20px;">
                            <button type="submit" class="assign-button">Aan mij toewijzen</button>
                        </form>
                    {% endif %}
                </div>
                <div class="detail-section">
                    <p><strong>Aanvrager:</strong> {{ ticket.requester_name }}</p>
                    <p><strong>Telefoon:</strong> {{ ticket.requester_phone }}</p>
                    <p><strong>E-mail:</strong> {{ ticket.requester_email }}</p>
                </div>
                <div class="detail-section description">
                    <h3>Beschrijving</h3>
                    <p>{{ ticket.description }}</p>
                </div>
                
                <!-- Sensitive notes weergave, let op gebruik van g.master_password -->
                {% if ticket.sensitive_notes and ticket.status not in ['Resolved', 'Closed'] %}
                <div class="detail-section sensitive-notes-view">
                    <h3>Vertrouwelijke Notities</h3>
                    <div class="warning-box">
                        <!-- De decryptie gebeurt in de route, hier tonen we alleen het resultaat -->
                        <p>{{ ticket.sensitive_notes }}</p>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <div class="ticket-sidebar">
            <div class="management-panel">
                <h3>Ticket Beheren</h3>
                <!-- Formulier voor Status Wijzigen en Reactie Toevoegen -->
                <form action="{{ url_for('main.update', ticket_id=ticket.id) }}" method="post" class="ticket-form">
                    <div class="form-group">
                        <label for="status">Status Wijzigen:</label>
                        <select id="status" name="status">
                            <option value="New" {% if ticket.status == 'New' %}selected{% endif %}>Nieuw</option>
                            <option value="In Progress" {% if ticket.status == 'In Progress' %}selected{% endif %}>In Behandeling</option>
                            <option value="Resolved" {% if ticket.status == 'Resolved' %}selected{% endif %}>Opgelost</option>
                            <option value="Closed" {% if ticket.status == 'Closed' %}selected{% endif %}>Gesloten</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="comment">Reactie Toevoegen:</label>
                        <!-- Template selectie blijft hetzelfde -->
                        <select id="template_select" onchange="applyTemplate()">
                            <option value="">Kies een sjabloon...</option>
                            {% for t in templates %}
                                <option value="{{ t.id }}">{{ t.title }}</option>
                            {% endfor %}
                        </select>
                        <textarea id="comment" name="comment" rows="6"></textarea>
                    </div>
                    <button type="submit" class="submit-button">Ticket Bijwerken</button>
                </form>

                <hr>

                <!-- Formulier voor Koppel Kennisbank Artikel -->
                <form action="{{ url_for('main.link_kb', ticket_id=ticket.id) }}" method="post" class="ticket-form">
                    <div class="form-group">
                        <label for="kb_article_id">Koppel Kennisbank Artikel:</label>
                        <select id="kb_article_id" name="kb_article_id">
                            <option value="">Selecteer een artikel...</option>
                            {% for article_option in kb_articles %}
                                <option value="{{ article_option.id }}" {% if ticket.kb_article_id == article_option.id %}selected{% endif %}>{{ article_option.category }} - {{ article_option.title }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <button type="submit" class="submit-button">Koppel Artikel</button>
                </form>
            </div>

            <div class="comments-history">
                <h3>Geschiedenis</h3>
                {% for item in comments %}
                    <div class="comment-item event-{{ item.event_type }}">
                        <p class="comment-body">{{ item.comment_text }}</p>
                        <p class="comment-meta">door <strong>{{ item.author }}</strong> op {{ item.created_at | datetimeformat }}</p>
                    </div>
                {% else %}
                    <p>Nog geen geschiedenis.</p>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- JavaScript om Sjablonen toe te passen -->
    <script>
        const templatesData = {
            {% for t in templates %}
                "{{ t.id }}": `{{ t.content | replace('\n', '\\n') | replace('\r', '') | safe }}`,
            {% endfor %}
        };

        function applyTemplate() {
            const templateId = document.getElementById('template_select').value;
            const commentBox = document.getElementById('comment');
            if (templateId && templatesData[templateId]) {
                commentBox.value = templatesData[templateId];
            }
        }
    </script>
{% endblock %}